<!DOCTYPE html>
<head>
  <meta name="viewport" content="user-scalable=no">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
  <link rel="stylesheet" href="unique-clock.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.27/webfontloader.js"></script>
</head>

<body>
  <div id="time-static" class="layer">
    <div class="time">
      <div class="hour">12</div>
      <div class="minute">00</div>
      <div class="second">00</div>
    </div>
    <div class="timezone">Somewhere / Earth</div>
  </div>

  <div id="time-overlay" class="layer layer--animatable">
    <div id="time-overlay-wrapper" class="layer--animatable-child">
      <div class="time">
        <div class="hour">12</div>
        <div class="minute">00</div>
        <div class="second">00</div>
      </div>
      <div class="timezone">Somewhere / Earth</div>
    </div>
  </div>

  <i class="fa fa-volume-up speaker"></i>
  <audio id="music" src="uniqlock.mp3" autoplay loop></audio>

  <div id="video-container" class="layer layer--animatable">
    <video id="video" class="layer--animatable-child" src="http://media4.giphy.com/media/11oRLY4FRk2s36/giphy.mp4" loop muted></video>
  </div>

  <script>
    var speaker = document.querySelector('.speaker');
    var music = document.getElementById('music');
    speaker.addEventListener('click', () => {
      speaker.classList.toggle('fa-volume-up');
      speaker.classList.toggle('fa-volume-off');
      music.volume = (music.volume == 1) ? 0 : 1;
    });

    music.addEventListener('canplaythrough', () => {
      music.play();
      lastDate = Date.now();
      setTimeout(() => setInterval(tick, 1000), 150);
    });

    var timeOverlay = document.getElementById('time-overlay');
    var videoContainer = document.getElementById('video-container');
    var video = document.getElementById('video');
    var hours = [...document.querySelectorAll('.hour')];
    var minutes = [...document.querySelectorAll('.minute')];
    var seconds = [...document.querySelectorAll('.second')];

    // Get the time without the morning/afternoon component.
    function setTime() {
      var date = new Date();
      // We use a regex here to get the time from localeTimeString() because some languages don't use AM/PM. For
      // example, zh-cn returns '下午2:46:52', ms-my returns '2:46:51 PTG', and ko-kr returns '오후 2:46:51'.
      var matches = date.toLocaleTimeString().match(/\d{1,2}:\d{2}:\d{2}/g);
      // Need to check if there's a match because some locales use non-Arabic numbers. For example, ar-dz returns
      // '٢:٤٦:٥١ م', mr returns '२:४६:५१ म.उ', and fa returns '۱۴:۴۶:۵۱'. We're just not going to support these
      // locales as a design choice due to their very unlikely usage.
      if (!matches) { return; }

      var timeSegments = matches[0].split(':');
      var hour = timeSegments[0];
      var minute = timeSegments[1];
      var second = timeSegments[2];

      hours.forEach((hourEl) => hourEl.textContent = (hour.length == 1) ? '0' + hour : hour);
      minutes.forEach((minuteEl) => minuteEl.textContent = minute);
      seconds.forEach((secondEl) => secondEl.textContent = second);
    }

    // Set the timezone string. This only needs to be done once on page load.
    (function setTimezone() {
      var timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      // Add some spaces between the text and the slash.
      var formattedTimezone = timezone.split('/').join(' / ');
      [...document.querySelectorAll('.timezone')].forEach((timezoneEl) => timezoneEl.textContent = formattedTimezone);
    })();

    var animationTimer = -1;
    var cycleTimer = -1;
    var isFirstCycle = true;

    function moveOverlayTime() {
      animationTimer = (animationTimer + 1) % 4;
      cycleTimer = (cycleTimer + 1) % 10;

      if ((cycleTimer >= 0 && cycleTimer <= 3)) {
        isFirstCycle = false;
        var animationClass = getAnimationClass(animationTimer);
        setAnimationClassOnElement(timeOverlay, animationClass);
      }
      else if (cycleTimer == 4) {
        var animationClass = getAnimationClass(animationTimer);
        setAnimationClassOnElement(videoContainer, animationClass);
        video.play();
      }
      else if (cycleTimer == 9 && !isFirstCycle) {
        var animationClass = getAnimationClass(animationTimer);
        setAnimationClassOnElement(videoContainer, animationClass);
        videoContainer.addEventListener('animationend', function onAnimationEnd() {
          video.pause();
          videoContainer.removeEventListener('animationend', onAnimationEnd);
          getNewVideo().then((result) => video.src = result.data.image_mp4_url);
        })
      }
    }

    function getAnimationClass(animationTimer) {
      if (animationTimer == 0) {
        return 'show-from-left';
      }
      else if (animationTimer == 1) {
        return 'hide-to-bottom';
      }
      else if (animationTimer == 2) {
        return 'show-from-right';
      }
      else {
        return 'hide-to-top';
      }
    }

    function setAnimationClassOnElement(element, animationClass) {
      element.classList.add(animationClass);
      element.classList.remove(element.previousAnimationClass);
      element.previousAnimationClass = animationClass;
    }

    function getNewVideo() {
      return new Promise((resolve, reject) => {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://api.giphy.com/v1/gifs/random?api_key=dc6zaTOxFJmzC&tag=funny');
        xhr.responseType = 'json';
        xhr.send();

        xhr.onreadystatechange = function() {
          if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status == 200) {
              resolve(xhr.response);
            }
            else {
               reject(xhr);
            }
          }
        }
      });
    }

    function tick() {
      // Delay the setTime() call so that it runs when the swipe animation is approximately 50% done.
      setTimeout(() => setTime(), 50);
      moveOverlayTime();
    }

    var lastDate = Date.now();

    setTime();
  </script>
</body>
