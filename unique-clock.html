<!DOCTYPE html>
<head>
  <meta name="viewport" content="user-scalable=no">
  <link rel="stylesheet" href="unique-clock.css">
  <script type="text/javascript" src="contents.js"></script>

</head>

<body>
  <div id="time-static" class="layer">
    <div class="time">
      <div class="hour">12</div>
      <div class="minute">00</div>
      <div class="second">00</div>
    </div>
    <div class="timezone">Somewhere / Earth</div>
  </div>

  <div id="time-overlay" class="layer layer--animatable">
    <div id="time-overlay-wrapper" class="layer--animatable-child">
      <div class="time">
        <div class="hour">12</div>
        <div class="minute">00</div>
        <div class="second">00</div>
      </div>
      <div class="timezone">Somewhere / Earth</div>
    </div>
  </div>

  <i class="fa fa-volume-up speaker"></i>
  <audio id="music" src="music/0.mp3" autoplay loop></audio>

  <div id="video-container" class="layer layer--animatable">
    <video id="video" class="layer--animatable-child" src="video/season1/5sec_1.webm" loop muted></video>
  </div>

  <script>
	var firstPlay = true;
	var day = true;
    var speaker = document.querySelector('.speaker');
    var music = document.getElementById('music');
    speaker.addEventListener('click', () => {
      speaker.classList.toggle('fa-volume-up');
      speaker.classList.toggle('fa-volume-off');
      music.volume = (music.volume == 1) ? 0 : 1;
    });

    music.addEventListener('canplaythrough', () => {
      music.play();
      lastDate = Date.now();
	  if (firstPlay === true){
        setTimeout(() => setInterval(tick, 1000), 50);
		firstPlay = false;
	  }
    });

    var timeOverlay = document.getElementById('time-overlay');
    var videoContainer = document.getElementById('video-container');
    var video = document.getElementById('video');
    var hours = [...document.querySelectorAll('.hour')];
    var minutes = [...document.querySelectorAll('.minute')];
    var seconds = [...document.querySelectorAll('.second')];

    // Get the time without the morning/afternoon component.
    function setTime() {
      var date = new Date();
      // We use a regex here to get the time from localeTimeString() because some languages don't use AM/PM. For
      // example, zh-cn returns '下午2:46:52', ms-my returns '2:46:51 PTG', and ko-kr returns '오후 2:46:51'.
	  
	  // I left the regex checking in place, but have defaulted everything to match the original clock.
	  // 'ja' locale always returns 24-hour time.
	  
      var matches = date.toLocaleTimeString('ja').match(/\d{1,2}:\d{2}:\d{2}/g);
      // Need to check if there's a match because some locales use non-Arabic numbers. For example, ar-dz returns
      // '٢:٤٦:٥١ م', mr returns '२:४६:५१ म.उ', and fa returns '۱۴:۴۶:۵۱'. We're just not going to support these
      // locales as a design choice due to their very unlikely usage.
      if (!matches) { return; }

      var timeSegments = matches[0].split(':');
      var hour = timeSegments[0];
      var minute = timeSegments[1];
      var second = timeSegments[2];

	  day = isDay(hours[0].textContent);  // Every tick checks if daytime or nighttime music/videos should play.

      hours.forEach((hourEl) => hourEl.textContent = (hour.length == 1) ? '0' + hour : hour);
      minutes.forEach((minuteEl) => minuteEl.textContent = minute);
      seconds.forEach((secondEl) => secondEl.textContent = second);
    }

    // Set the timezone string. This only needs to be done once on page load.
    (function setTimezone() {
      var timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      // Add some spaces between the text and the slash.
      var formattedTimezone = timezone.split('/').join(' / ');
      [...document.querySelectorAll('.timezone')].forEach((timezoneEl) => timezoneEl.textContent = formattedTimezone);
    })();

    var animationTimer = -1;
    var cycleTimer = -1;
    var isFirstCycle = true;
	var hourly = false;

    function moveOverlayTime() {
      animationTimer = (animationTimer + 1) % 4;
      cycleTimer = (cycleTimer + 1) % 10;
	  
	  if (minutes[0].textContent == 0 || isFirstCycle) {
		document.getElementById('time-static').style.color = rawColors[parseInt(hours[0].textContent)];
		document.getElementById('time-overlay').style.backgroundColor = rawColors[parseInt(hours[0].textContent)];
	  }
      if ((cycleTimer >= 0 && cycleTimer <= 3)) {
        isFirstCycle = false;
        var animationClass = getAnimationClass(animationTimer);
        setAnimationClassOnElement(timeOverlay, animationClass);
      }
      else if (cycleTimer == 4) {
        var animationClass = getAnimationClass(animationTimer);
        setAnimationClassOnElement(videoContainer, animationClass);
        video.play();
      }
      else if (cycleTimer == 9 && !isFirstCycle) {
        var animationClass = getAnimationClass(animationTimer);
        setAnimationClassOnElement(videoContainer, animationClass);
        videoContainer.addEventListener('animationend', function onAnimationEnd() {
          video.pause();
          videoContainer.removeEventListener('animationend', onAnimationEnd);
		  console.log(video.src = getVideo());
        })
      }
	  if (seconds[1].textContent == 0) {
		  console.log(music.src = getMusic());
		  music.play();
	  }
    }

    function getAnimationClass(animationTimer) {
      if (animationTimer == 0) {
        return 'show-from-left';
      }
      else if (animationTimer == 1) {
        return 'hide-to-bottom';
      }
      else if (animationTimer == 2) {
        return 'show-from-right';
      }
      else {
        return 'hide-to-top';
      }
    }

    function setAnimationClassOnElement(element, animationClass) {
      element.classList.add(animationClass);
      element.classList.remove(element.previousAnimationClass);
      element.previousAnimationClass = animationClass;
    }

	function getMusic() {
		if (day) {  // Function pulls day music during day, night music during night.
			console.log("day");
			return "music/" + song["day"][randomInt(0,song["day"].length - 1)];			
		} else {
			console.log("night");
			return "music/" + song["night"][randomInt(0,song["night"].length - 1)];
		}
	}

	function getVideo() {  //Function pulls day videos during day, night videos during night.
		var season = randomInt(1, vid.length - 1);	
		if (day) {
			return "video/season" + season + "/" + vid[season]["day"][randomInt(0,vid[season]["day"].length - 1)];			
		} else {
			while (vid[season]["night"] === null) {
				var season = randomInt(1, vid.length - 1);	
			}
			return "video/season" + season + "/" + vid[season]["night"][randomInt(0,vid[season]["night"].length - 1)];
		}
	}
	
	// giphy functionality removed.
	
	function randomInt(min, max) {
		min = parseInt(min);
		max = parseInt(max);
		return Math.floor(min + Math.random() * (max - min + 1));
	}
	
	function isDay(hour) {
		if (hour > 7 && hour < 20) {
			return true;
		} else {
			return false;
		}
	}

    function tick() {
      // Delay the setTime() call so that it runs when the swipe animation is approximately 50% done.
      setTimeout(() => setTime(), 50);
      moveOverlayTime();
    }

    var lastDate = Date.now();

    setTime();
  </script>
</body>
